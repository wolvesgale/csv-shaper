<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSVæ•´å½¢ï¼ˆå§“ååˆ†å‰²ãƒ»åˆ—åˆã‚ã›ï¼‰</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%2338bdf8'/%3E%3Ctext x='32' y='40' font-size='28' text-anchor='middle' fill='%2304202b'%3EC%3C/text%3E%3C/svg%3E" />
  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; }
    header { padding:16px 20px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:linear-gradient(0deg, rgba(15,23,42,0.2), rgba(15,23,42,0.9)); backdrop-filter:blur(8px); }
    h1 { font-size:18px; margin:0; letter-spacing:.02em }
    main { max-width:1100px; margin:24px auto; padding:0 16px; }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:16px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 320px; }
    label { display:block; font-weight:600; margin-bottom:6px; color:var(--muted) }
    input[type="file"], select, button { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #243041; background:#0b1220; color:var(--text); }
    button.primary { background:var(--accent); color:#04202b; border:none; font-weight:700; }
    button:disabled { opacity:.5 }
    .muted { color:var(--muted) }
    .pill { display:inline-flex; align-items:center; gap:6px; border:1px solid #243041; border-radius:999px; padding:4px 10px; margin:4px 8px 0 0; font-size:12px; color:#93c5fd }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { border-bottom:1px solid #1f2937; padding:6px 8px; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .footer { margin-top:24px; color:var(--muted); font-size:12px }
    details { border:1px dashed #243041; border-radius:12px; padding:10px 12px; }
    summary { cursor:pointer; color:#93c5fd; font-weight:600 }
  </style>
</head>
<body>
  <header><h1>CSVæ•´å½¢ï¼ˆå§“ååˆ†å‰²ãƒ»ã‚µãƒ³ãƒ—ãƒ«åˆ—æº–æ‹ ï¼‰</h1></header>
  <main>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>â‘  ã‚µãƒ³ãƒ—ãƒ«CSVï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ—å®šç¾©ï¼‰</label>
          <input id="sampleCsv" type="file" accept=".csv" />
          <p class="muted">â€» <code>admin-customer-list-sample.csv</code> ã‚’æŒ‡å®šã€‚æœªæŒ‡å®šã§å–å¾—å¤±æ•—æ™‚ã¯æ—¢å®šåˆ—ã‚’ä½¿ç”¨ã€‚</p>
          <div id="sampleStatus" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="col">
          <label>â‘¡ å¤‰æ›ã™ã‚‹å…ƒCSVï¼ˆäººè„ˆãƒªã‚¹ãƒˆï¼‰</label>
          <input id="sourceCsv" type="file" accept=".csv" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>ãƒ•ãƒ«ãƒãƒ¼ãƒ åˆ—ï¼ˆæ°å/å§“åãªã©ï¼‰</label>
          <select id="fullNameCol">
            <option value="">è‡ªå‹•æ¤œå‡ºï¼ˆæ°å/å§“å/åå‰/Nameï¼‰</option>
          </select>
        </div>
        <div class="col">
          <label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
          <div>
            <span class="pill"><input id="stripAscii" type="checkbox" checked> æ¼¢å­—ï¼‹è‹±å­— â†’ è‹±å­—ã®ã¿å‰Šé™¤ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã¯ä¿æŒï¼‰</span>
            <span class="pill"><input id="keepSpaces" type="checkbox" checked> åˆ†å‰²ã¯æœ€åˆã®åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿ï¼ˆå³å´ã®ç©ºç™½ã¯ä¿æŒï¼‰</span>
            <span class="pill"><input id="useZenkaku" type="checkbox" checked> å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚‚åˆ†å‰²å¯¾è±¡</span>
            <span class="pill"><input id="useHeuristic" type="checkbox" checked> ã‚¹ãƒšãƒ¼ã‚¹ç„¡ã—ã¯æ¨å®šåˆ†å‰²</span>
          </div>
        </div>
      </div>
      <div class="row"><div class="col"><button id="convertBtn" class="primary" disabled>â‘¢ å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆUTF-8-SIGï¼‰</button></div></div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>ã‚µãƒ³ãƒ—ãƒ«åˆ—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
          <div id="sampleCols" class="muted">æœªèª­è¾¼</div>
        </div>
        <div class="col">
          <label>å…¥åŠ›CSVï¼šå…ˆé ­è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
          <div style="overflow:auto; max-height:260px"><table id="previewTable"></table></div>
        </div>
      </div>
    </div>

    <details class="card">
      <summary>ä»•æ§˜ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
      <ul>
        <li>ã‚µãƒ³ãƒ—ãƒ«åˆ—ã«<strong>å®Œå…¨æº–æ‹ </strong>ï¼ˆç„¡ã„åˆ—ã¯ç ´æ£„ï¼è¶³ã‚Šãªã„åˆ—ã¯ç©ºæ¬„è£œå®Œï¼‰ã€‚</li>
        <li>æ°åã¯<strong>æœ€åˆã®åŠè§’ã‚¹ãƒšãƒ¼ã‚¹</strong>ã§åˆ†å‰²ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å…¨è§’ã‚‚åˆ†å‰²ã€‚</li>
        <li>æ¼¢å­—ï¼‹è‹±å­—æ··åœ¨ã¯ã€è‹±å­—ã®ã¿é™¤å»ã—ã¦ã‹ã‚‰åˆ†å‰²ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã¯ç¶­æŒï¼‰ã€‚</li>
        <li>ã€Œå§“/åã€ãŒåˆ¥åˆ—ã§æ¥ãŸå ´åˆã¯<strong>ãã®ã¾ã¾å†™ã™</strong>ï¼ˆç©ºãªã‚‰ä¸¡æ–¹ã€Œæœªå…¥åŠ›ã€ï¼‰ã€‚</li>
        <li>åˆ†å‰²ä¸èƒ½ã§å§“ã ã‘å¾—ã‚‰ã‚ŒãŸå ´åˆã¯<strong>åã«ã€Œâ€»ã€</strong>ã€‚å®Œå…¨ã«ä¸æ˜ãªã‚‰<strong>ä¸¡æ–¹ã€Œæœªå…¥åŠ›ã€</strong>ã€‚</li>
        <li>ä¼šç¤¾å/éƒ¨ç½²/å½¹è·ã¯è¦‹å‡ºã—èªã‚„æ–‡é¢ã‹ã‚‰æ¨å®šã—ã¦é…ç½®ã€‚</li>
        <li>ã‚µãƒ³ãƒ—ãƒ«CSVå–å¾—å¤±æ•—æ™‚ã¯æ—¢å®šåˆ—ï¼š<code>company_name, company_number, last_name, first_name, department, position, contact_url, notes, supporter_id</code></li>
        <li>2500ä»¶ã‚’è¶…ãˆã‚‹å ´åˆã¯<strong>2500ä»¶ã”ã¨</strong>ã«è‡ªå‹•åˆ†å‰²ã—ã¦è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã€‚</li>
      </ul>
    </details>

    <div class="footer">No server / static. Deploy anywhere.</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const sampleInput = document.getElementById('sampleCsv');
    const sourceInput = document.getElementById('sourceCsv');
    const fullNameColSelect = document.getElementById('fullNameCol');
    const convertBtn = document.getElementById('convertBtn');
    const sampleColsDiv = document.getElementById('sampleCols');
    const previewTable = document.getElementById('previewTable');
    const stripAscii = document.getElementById('stripAscii');
    const keepSpaces = document.getElementById('keepSpaces');
    const useZenkaku = document.getElementById('useZenkaku');
    const useHeuristic = document.getElementById('useHeuristic');
    const sampleStatus = document.getElementById('sampleStatus');

    const DEFAULT_TARGET_HEADERS = [
      'company_name','company_number','last_name','first_name','department','position','contact_url','notes','supporter_id'
    ];

    // è¦‹å‡ºã—â†’æ¨™æº–åˆ—ãƒãƒƒãƒ—ï¼ˆæ—¥æœ¬èªã‚‚ã‚«ãƒãƒ¼ï¼‰
    const headerMap = {
      'ä¼šç¤¾å':'company_name','ç¤¾å':'company_name','ä¼æ¥­å':'company_name','æ³•äººå':'company_name','å‹¤å‹™å…ˆ':'company_name','å‹¤å‹™å…ˆå':'company_name',
      'ä¼šç¤¾ç•ªå·':'company_number',
      'éƒ¨ç½²':'department','éƒ¨é–€':'department','æ‰€å±':'department','éƒ¨ç½²å':'department',
      'å½¹è·':'position','å½¹å‰²':'position','è‚©æ›¸':'position','è·ä½':'position','è·å':'position',
      'URL':'contact_url','é€£çµ¡å…ˆ':'contact_url',
      'å‚™è€ƒ':'notes','ãƒ¡ãƒ¢':'notes','æ³¨è¨˜':'notes',
      'ã‚µãƒãƒ¼ã‚¿ãƒ¼ID':'supporter_id','supporterId':'supporter_id'
    };

    // å§“ãƒ»åã®å€™è£œã‚­ãƒ¼
    const LAST_NAME_KEYS  = ['å§“','è‹—å­—','åå­—','last_name','lastName','family_name','familyName'];
    const FIRST_NAME_KEYS = ['å','åå‰','first_name','firstName','given_name','givenName'];

    // å½¹è·/éƒ¨ç½²ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    const POSITION_KEYWORDS = /(å–ç· å½¹|ä»£è¡¨|ç¤¾é•·|å‰¯ç¤¾é•·|CEO|COO|CTO|CFO|CIO|Chief|ä¼šé•·|å°‚å‹™|å¸¸å‹™|æœ¬éƒ¨é•·|éƒ¨é•·|æ¬¡é•·|èª²é•·|ãƒãƒãƒ¼ã‚¸ãƒ£|Manager|Lead|ãƒªãƒ¼ãƒ€|ä¸»ä»»|å½¹å“¡|é¡§å•|Advisor|é¡§å®¢æ‹…å½“|å–¶æ¥­æ‹…å½“|éƒ¨é–€é•·)/i;
    const DEPT_KEYWORDS     = /(æœ¬éƒ¨|éƒ¨|èª²|å®¤|ã‚»ãƒ³ã‚¿ãƒ¼|äº‹æ¥­éƒ¨|å–¶æ¥­éƒ¨|ç·å‹™éƒ¨|äººäº‹éƒ¨|çµŒç†éƒ¨|è²¡å‹™éƒ¨|é–‹ç™ºéƒ¨|ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°|åºƒå ±|æ³•å‹™|ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µã‚¯ã‚»ã‚¹|CS|ä¼ç”»|å“è³ª|è£½é€ |DX|IT|æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ |æƒ…å ±ä¼ç”»)/i;

    // ã‚ˆãã‚ã‚‹å§“ï¼ˆæŠœç²‹ï¼‰
    const SURNAMES = new Set(['ä½è—¤','éˆ´æœ¨','é«˜æ©‹','ç”°ä¸­','ä¼Šè—¤','æ¸¡è¾º','å±±æœ¬','ä¸­æ‘','å°æ—','åŠ è—¤','å‰ç”°','å±±ç”°','ä½ã€…æœ¨','å±±å£','æ–è—¤','æ–‰è—¤','äº•ä¸Š','æœ¨æ‘','æ—','æ¸…æ°´','å±±å´','é˜¿éƒ¨','æ£®','æ± ç”°','æ©‹æœ¬','çŸ³å·','å±±ä¸‹','ä¸­å³¶','å°å·','å‰ç”°','å²¡ç”°','é•·è°·å·','æ‘ä¸Š','è—¤ç”°','å¾Œè—¤','å°é‡','æ¾æœ¬','è¿‘è—¤','çŸ³äº•','å‚æœ¬','é è—¤','é’æœ¨','è—¤äº•','è¥¿æ‘','ç¦ç”°','å¤ªç”°','ä¸‰æµ¦','ä¸­é‡','ä¸­å·','æ¾ç”°','ç«¹å†…','å°å³¶','ç”°æ‘','é‡‘å­','å’Œç”°','çŸ³ç”°','ä¸­å±±','åŸç”°','é…’äº•','å·¥è—¤','æ± ä¸Š','å¤§è¥¿','æœ¬ç”°','å®®æœ¬','å¹³äº•','æŸ´ç”°','é»’ç”°','åŒ—æ‘','å³¶ç”°','å²©ç”°','è…åŸ','è¥¿ç”°','å†…ç”°','ç§‹å±±','å®‰ç”°','æ˜Ÿé‡']);

    const EMPTY_NAME_TOKENS = new Set(['', 'æœªå…¥åŠ›', 'false', 'FALSE', 'na', 'NA', '-', 'ãƒ¼', 'N/A']);

    let sampleHeaders = [];
    let sourceRows = [];

    function setButtonState(){ convertBtn.disabled = !(sampleHeaders.length && sourceRows.length); }

    function tryAutoFullNameCol(headers){
      const keys = ['æ°å','å§“å','åå‰','ãŠåå‰','Name','name','ãƒ•ãƒ«ãƒãƒ¼ãƒ '];
      const hit = headers.find(h => keys.some(k => h.includes(k)));
      return hit || '';
    }

    function renderPreview(){
      previewTable.innerHTML = '';
      if(!sourceRows.length) return;
      const headers = Object.keys(sourceRows[0] || {});
      const thead = document.createElement('thead');
      const tr = document.createElement('tr');
      headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; tr.appendChild(th); });
      thead.appendChild(tr); previewTable.appendChild(thead);
      const tbody = document.createElement('tbody');
      sourceRows.slice(0,10).forEach(row=>{
        const tr = document.createElement('tr');
        headers.forEach(h => { const td = document.createElement('td'); td.textContent = row[h] ?? ''; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
      previewTable.appendChild(tbody);
    }

    // ===== å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ç”Ÿæˆ =====
    function deriveSuffixFromSourceName(filename) {
      if (!filename) return '';
      const base = filename.replace(/\.[^.]+$/, '');
      const withoutJinmyaku = base.replace(/äººè„ˆ/g, '');
      const kanjiChars = (withoutJinmyaku.match(/[\u4E00-\u9FFF]/g) || []).join('');
      if (kanjiChars.length > 0) return sanitizeForFilename(kanjiChars);
      const tokens = base
        .split(/[^A-Za-z]+/)
        .filter(Boolean)
        .filter(t => !/^(rp|xx)$/i.test(t))
        .filter(t => !/^\d+$/.test(t));
      if (tokens.length === 0) return '';
      return sanitizeForFilename(tokens.join('_'));
    }
    function sanitizeForFilename(s) {
      const cleaned = s.replace(/[\\/:*?"<>|]/g, '').replace(/\s+/g, '');
      return cleaned.slice(0, 80);
    }

    // â€”â€” åå‰åˆ†å‰²ç³» â€”â€” //
    function heuristicSplitKanji(s){
      for(const ln of Array.from(SURNAMES).sort((a,b)=>b.length-a.length)){
        if(s.startsWith(ln)) return { last: ln, first: s.slice(ln.length) };
      }
      const kanji = (s.match(/[\u4E00-\u9FFF]/g) || []).length;
      if(kanji >= 4) return { last: s.slice(0,2), first: s.slice(2) };
      if(kanji === 3) return { last: s.slice(0,1), first: s.slice(1) };
      const mid = Math.max(1, Math.floor(s.length/2));
      return { last: s.slice(0,mid), first: s.slice(mid) };
    }

    function normalizeName(raw){
      if (raw == null) return { last: '', first: '' };
      let s = String(raw).trim();
      // ã€Œæœªå…¥åŠ›/ç©ºã€ã‚’æ¤œçŸ¥ã—ãŸã‚‰å³ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆä¸¡æ–¹æœªå…¥åŠ›æ‰±ã„ï¼‰
      if (EMPTY_NAME_TOKENS.has(s)) return { last: '', first: '' };

      const hasKanji = /[\u4E00-\u9FFF]/.test(s);
      const hasLatin = /[A-Za-z]/.test(s);

      // æ¼¢å­—ä¸»ä½“
      if (hasKanji) {
        if (stripAscii.checked) s = s.replace(/[A-Za-z\-_'`~!@#\$%\^&*()=+\[\]{}|;:\",.<>?]+/g, '').trim();
        let i = s.indexOf(' ');
        if (i < 0 && useZenkaku && useZenkaku.checked) i = s.indexOf('ã€€');
        if (i >= 0) {
          const last  = s.slice(0, i).trim();
          let first   = s.slice(i + 1);
          if (!keepSpaces.checked) first = first.replace(/\s+/g, ' ').trim();
          return { last, first };
        }
        if (useHeuristic && useHeuristic.checked) return heuristicSplitKanji(s);
        return { last: s, first: '' };
      }

      // ãƒ­ãƒ¼ãƒå­—ï¼ˆæœ€å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ï¼šå³=last / å·¦=firstï¼‰
      if (hasLatin) {
        s = s.replace(/\s+/g, ' ').trim();
        const j = s.lastIndexOf(' ');
        if (j === -1) return { last: s, first: '' };
        const first = s.slice(0, j).trim();
        const last  = s.slice(j + 1).trim();
        return { last, first };
      }

      // ã‹ãªç­‰
      let k = s.indexOf(' ');
      if (k < 0 && useZenkaku && useZenkaku.checked) k = s.indexOf('ã€€');
      if (k >= 0) {
        const last = s.slice(0, k).trim();
        let first  = s.slice(k + 1);
        if (!keepSpaces.checked) first = first.replace(/\s+/g, ' ').trim();
        return { last, first };
      }
      return { last: s, first: '' };
    }

    // ã€Œå§“/åã€ãŒåˆ¥åˆ—ã§æ¥ãŸã‚±ãƒ¼ã‚¹ã‚’æ‹¾ã†
    function pickSeparateNames(row){
      const keys = Object.keys(row || {});
      const lastKey  = keys.find(k => LAST_NAME_KEYS.some(t => k.toLowerCase() === t.toLowerCase()));
      const firstKey = keys.find(k => FIRST_NAME_KEYS.some(t => k.toLowerCase() === t.toLowerCase()));
      const last  = lastKey  ? String(row[lastKey]  ?? '').trim() : '';
      const first = firstKey ? String(row[firstKey] ?? '').trim() : '';
      const bothEmpty = EMPTY_NAME_TOKENS.has(last) && EMPTY_NAME_TOKENS.has(first);
      return { last: bothEmpty ? '' : last, first: bothEmpty ? '' : first, found: Boolean(lastKey || firstKey) };
    }

    function adoptHeadersFromSample(meta){
      if(meta && meta.fields && meta.fields.length){
        sampleHeaders = meta.fields;
        sampleColsDiv.textContent = sampleHeaders.join(' | ');
        sampleStatus.textContent = 'ã‚µãƒ³ãƒ—ãƒ«CSVã‚’ä½¿ç”¨ä¸­';
      }else{
        sampleHeaders = DEFAULT_TARGET_HEADERS.slice();
        sampleColsDiv.textContent = sampleHeaders.join(' | ');
        sampleStatus.textContent = 'ã‚µãƒ³ãƒ—ãƒ«CSVãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚æ—¢å®šåˆ—ã‚’ä½¿ç”¨ä¸­';
      }
          // ğŸ”½ ã“ã“ã‚’è¿½åŠ ï¼šç©ºæ¬„ãªã‚‰è‡ªå‹•ã§æœªå…¥åŠ›è£œå®Œ
    if(!last)  last='æœªå…¥åŠ›';
    if(!first) first='æœªå…¥åŠ›';
    o.last_name=last;
    o.first_name=first;
    if(Object.values(o).some(v=>String(v).trim()!==''))out.push(o);
  }
    }

    async function parseFile(file,onDone){
      return new Promise(resolve=>{
        Papa.parse(file,{
          header:true,
          skipEmptyLines:'greedy',
          complete:(res)=>{ onDone(res.data||[],res.meta||{}); resolve(); },
          error:()=>{ onDone([],{}); resolve(); }
        });
      });
    }

    async function fetchLocalSampleFallback(){
      try{
        const resp = await fetch('./admin-customer-list-sample.csv',{ credentials:'same-origin' });
        if(!resp.ok) throw new Error('fetch failed');
        const text = await resp.text();
        const parsed = Papa.parse(text,{ header:true });
        adoptHeadersFromSample(parsed.meta);
      }catch(_){
        adoptHeadersFromSample({});
      }finally{
        setButtonState();
      }
    }

    // å…¥åŠ›èª­ã¿è¾¼ã¿ï¼šãƒ˜ãƒƒãƒ€ãªã—CSVã§ã‚‚å·¦ç«¯ã‚’æ°åã¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    sourceInput.addEventListener('change', async () => {
      const f = sourceInput.files && sourceInput.files[0];
      if (!f) return;

      await parseFile(f, (rows) => {
        sourceRows = rows;
        renderPreview();

        const headers = Object.keys(rows[0] || {});
        fullNameColSelect.innerHTML =
          '<option value="">è‡ªå‹•æ¤œå‡ºï¼ˆæ°å/å§“å/åå‰/Nameï¼‰</option>' +
          headers.map((h) => `<option>${h}</option>`).join('');

        let detected = tryAutoFullNameCol(headers);
        if (!detected && headers.length > 0) detected = headers[0]; // å…ˆé ­åˆ—ã‚’æ°åæ‰±ã„
        fullNameColSelect.value = detected || '';
        setButtonState();
      });
    });

    sampleInput.addEventListener('change', async()=>{
      const f = sampleInput.files && sampleInput.files[0];
      if(!f) return;
      Papa.parse(f,{
        header:true, preview:1,
        complete:(res)=>{ adoptHeadersFromSample(res.meta||{}); setButtonState(); }
      });
    });

    function looksCompanyLike(text){
      if(!text) return false;
      return /(æ ªå¼ä¼šç¤¾|æœ‰é™ä¼šç¤¾|åˆåŒä¼šç¤¾|åˆè³‡ä¼šç¤¾|åˆåä¼šç¤¾|Inc\.?|LLC|GmbH|Ltd\.?|Co\.|Company|Holdings|HD|å¤§å­¦|ç ”ç©¶æ‰€|æ©Ÿæ§‹|è²¡å›£|ç¤¾å›£)/i.test(text);
    }

    function looksPositionLike(text){
      return POSITION_KEYWORDS.test(text || '');
    }
    function looksDepartmentLike(text){
      return DEPT_KEYWORDS.test(text || '');
    }

    // 2500ä»¶ã”ã¨ã«åˆ†å‰²ä¿å­˜
    function saveCsvChunks(rows, srcFileName, sampleHeaders){
      const suffix  = deriveSuffixFromSourceName(srcFileName);
      const base    = 'converted_admin_customer_list';
      const chunkSize = 2500;
      const total = rows.length;
      const chunks = Math.ceil(total / chunkSize);

      for(let i=0;i<chunks;i++){
        const slice = rows.slice(i*chunkSize, (i+1)*chunkSize);
        const csv = Papa.unparse(
          { fields: sampleHeaders, data: slice.map(r => sampleHeaders.map(h => r[h] ?? '')) },
          { quotes:true, newline:"\n" }
        );
        const BOM  = new Uint8Array([0xEF,0xBB,0xBF]);
        const blob = new Blob([BOM, csv], { type:'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const tag = (chunks>1) ? `_part${String(i+1).padStart(2,'0')}of${String(chunks).padStart(2,'0')}` : '';
        a.download = `${base}${suffix ? '_' + suffix : ''}${tag}.csv`;
        a.click();
        URL.revokeObjectURL(a.href);
      }
    }

    convertBtn.addEventListener('click', ()=>{
      if(!sampleHeaders.length || !sourceRows.length) return;

      const fullNameKey = fullNameColSelect.value || tryAutoFullNameCol(Object.keys(sourceRows[0] || {}));

      const wantLast  = sampleHeaders.includes('last_name')  || sampleHeaders.includes('å§“');
      const wantFirst = sampleHeaders.includes('first_name') || sampleHeaders.includes('å');
      const lastKey   = sampleHeaders.includes('last_name')  ? 'last_name'  : (sampleHeaders.includes('å§“') ? 'å§“' : null);
      const firstKey  = sampleHeaders.includes('first_name') ? 'first_name' : (sampleHeaders.includes('å') ? 'å' : null);

      const out = [];

      for(const row of sourceRows){
        const outRow = Object.fromEntries(sampleHeaders.map(h=>[h,'']));

        // 1) åŒåãƒ˜ãƒƒãƒ€ã¯ã‚³ãƒ”ãƒ¼
        for(const h of sampleHeaders){ if(h in row) outRow[h] = row[h]; }
        // 1.5) æ—¥æœ¬èªâ†’è‹±èªãƒ˜ãƒƒãƒ€ãƒãƒƒãƒ”ãƒ³ã‚°
        for(const [jp,en] of Object.entries(headerMap)){
          if(en && sampleHeaders.includes(en) && (jp in row) && String(row[jp]??'').trim()!==''){
            outRow[en] = row[jp];
          }
        }

        // 1.8) company_name/department/position ãŒç©ºãªã‚‰ã€é©å½“ãªåˆ—ã®å€¤ã‹ã‚‰æ¨å®š
        if(sampleHeaders.includes('company_name') && !outRow['company_name']){
          // æ˜ç¤ºã® company ç³»ãƒ˜ãƒƒãƒ€ãŒç„¡ã„æ™‚ã€3åˆ—ç›®ãªã©ã‹ã‚‰æ‹¾ã†
          const keys = Object.keys(row||{});
          for(let k of keys){
            const v = String(row[k] ?? '').trim();
            if(!v) continue;
            if(looksCompanyLike(v)){ outRow['company_name']=v; break; }
          }
          // ãã‚Œã§ã‚‚ç©ºãªã‚‰ã€æ°ååˆ—ä»¥å¤–ã®3åˆ—ç›®ã‚’å€™è£œã«
          if(!outRow['company_name'] && keys[2] && keys[2] !== fullNameKey){
            const v = String(row[keys[2]] ?? '').trim();
            if(v) outRow['company_name'] = v;
          }
        }
        if(sampleHeaders.includes('position') && !outRow['position']){
          const keys = Object.keys(row||{});
          for(let k of keys){
            const v = String(row[k] ?? '').trim();
            if(looksPositionLike(v)){ outRow['position']=v; break; }
          }
        }
        if(sampleHeaders.includes('department') && !outRow['department']){
          const keys = Object.keys(row||{});
          // è¤‡æ•°å€™è£œãŒã‚ã‚‹ã¨ãã¯çµåˆï¼ˆæ”¹è¡Œï¼‰
          const depts = [];
          for(let k of keys){
            const v = String(row[k] ?? '').trim();
            if(looksDepartmentLike(v)) depts.push(v);
          }
          if(depts.length) outRow['department'] = Array.from(new Set(depts)).join('\n');
        }

        // 2) æ°åï¼ˆå„ªå…ˆé †ï¼‰
        // 2-a) ã€Œå§“/åã€åˆ†é›¢åˆ—ãŒã‚ã‚Œã°ãã‚Œã‚’æœ€å„ªå…ˆã§æ¡ç”¨
        let lastVal = '', firstVal = '';
        if (wantLast || wantFirst){
          const sep = pickSeparateNames(row);
          if (sep.found && (sep.last || sep.first)){
            lastVal  = sep.last;
            firstVal = sep.first;
          } else if (fullNameKey){
            // 2-b) ãƒ•ãƒ«ãƒãƒ¼ãƒ åˆ—ã‹ã‚‰åˆ†å‰²
            const rawName = String(row[fullNameKey] ?? '').trim();
            if (EMPTY_NAME_TOKENS.has(rawName.toLowerCase ? rawName.toLowerCase() : rawName)) {
              lastVal = ''; firstVal = '';
            } else {
              const nm = normalizeName(rawName);
              lastVal  = (nm.last  ?? '').trim();
              firstVal = (nm.first ?? '').trim();
              // åˆ†å‰²ä¸èƒ½ï¼ˆå§“ã®ã¿ï¼‰ã®å ´åˆã¯åã«ã€Œâ€»ã€
              if (lastVal && !firstVal) firstVal = 'â€»';
            }
          }
        }

        // 2-c) ã¾ã£ãŸãå–ã‚Œãªã‹ã£ãŸã‚‰ä¸¡æ–¹ã€Œæœªå…¥åŠ›ã€
        if (!lastVal && !firstVal){
          lastVal = 'æœªå…¥åŠ›';
          firstVal = 'æœªå…¥åŠ›';
        }

        if (lastKey)  outRow[lastKey]  = lastVal;
        if (firstKey) outRow[firstKey] = firstVal;

        // 3) 1ã¤ã§ã‚‚å€¤ãŒã‚ã‚Œã°æ¡ç”¨
        const hasAny = Object.values(outRow).some(v => (v!=null) && String(v).trim()!=='');
        if(hasAny) out.push(outRow);
      }

      // 4) å‡ºåŠ›ï¼ˆ2500ä»¶ã§åˆ†å‰²ï¼‰
      const srcName = (sourceInput.files && sourceInput.files[0] && sourceInput.files[0].name) || '';
      saveCsvChunks(out, srcName, sampleHeaders);
    });

    fetchLocalSampleFallback();
  </script>
</body>
</html>
