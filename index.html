<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV整形（姓名分割・列合わせ）</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%2338bdf8'/%3E%3Ctext x='32' y='40' font-size='28' text-anchor='middle' fill='%2304202b'%3EC%3C/text%3E%3C/svg%3E" />
  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; }
    header { padding:16px 20px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:linear-gradient(0deg, rgba(15,23,42,0.2), rgba(15,23,42,0.9)); backdrop-filter:blur(8px); }
    h1 { font-size:18px; margin:0; letter-spacing:.02em }
    main { max-width:1100px; margin:24px auto; padding:0 16px; }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:16px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 320px; }
    label { display:block; font-weight:600; margin-bottom:6px; color:var(--muted) }
    input[type="file"], select, button { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #243041; background:#0b1220; color:var(--text); }
    button.primary { background:var(--accent); color:#04202b; border:none; font-weight:700; }
    button:disabled { opacity:.5 }
    .muted { color:var(--muted) }
    .pill { display:inline-flex; align-items:center; gap:6px; border:1px solid #243041; border-radius:999px; padding:4px 10px; margin:4px 8px 0 0; font-size:12px; color:#93c5fd }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { border-bottom:1px solid #1f2937; padding:6px 8px; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .footer { margin-top:24px; color:var(--muted); font-size:12px }
    details { border:1px dashed #243041; border-radius:12px; padding:10px 12px; }
    summary { cursor:pointer; color:#93c5fd; font-weight:600 }
  </style>
</head>
<body>
  <header><h1>CSV整形（姓名分割・サンプル列準拠）</h1></header>
  <main>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>① サンプルCSV（ターゲット列定義）</label>
          <input id="sampleCsv" type="file" accept=".csv" />
          <p class="muted">※ <code>admin-customer-list-sample.csv</code> を指定。未指定で取得失敗時は既定列を使用。</p>
          <div id="sampleStatus" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="col">
          <label>② 変換する元CSV（人脈リスト）</label>
          <input id="sourceCsv" type="file" accept=".csv" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>フルネーム列（氏名/姓名など）</label>
          <select id="fullNameCol">
            <option value="">自動検出（氏名/姓名/名前/Name）</option>
          </select>
        </div>
        <div class="col">
          <label>オプション</label>
          <div>
            <span class="pill"><input id="stripAscii" type="checkbox" checked> 漢字＋英字 → 英字のみ削除（スペースは保持）</span>
            <span class="pill"><input id="keepSpaces" type="checkbox" checked> 分割は最初のスペースのみ（右側の空白は保持）</span>
            <span class="pill"><input id="useZenkaku" type="checkbox" checked> 全角スペースも分割対象</span>
            <span class="pill"><input id="useHeuristic" type="checkbox" checked> スペース無しは推定分割</span>
          </div>
        </div>
      </div>
      <div class="row"><div class="col"><button id="convertBtn" class="primary" disabled>③ 変換してダウンロード（UTF-8-SIG）</button></div></div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>サンプル列プレビュー</label>
          <div id="sampleCols" class="muted">未読込</div>
        </div>
        <div class="col">
          <label>入力CSV：先頭行プレビュー</label>
          <div style="overflow:auto; max-height:260px"><table id="previewTable"></table></div>
        </div>
      </div>
    </div>

    <details class="card">
      <summary>仕様（クリックで展開）</summary>
      <ul>
        <li>サンプル列に<strong>完全準拠</strong>（無い列は破棄／足りない列は空欄補完）。</li>
        <li>氏名は<strong>最初の半角 or 全角スペース</strong>で分割（名側の空白保持オプションあり）。</li>
        <li>漢字＋英字混在は、英字のみ除去してから分割（スペースは維持）。</li>
        <li>サンプルCSV取得失敗時は既定列：<code>company_name, company_number, last_name, first_name, department, position, contact_url, notes, supporter_id</code></li>
        <li>名前が「未入力」のときは姓・名ともに「未入力」。両方空は行スキップ。姓のみで名が空は名に「※」。</li>
        <li>2,500件を超える場合は 2,500件ずつ分割して複数CSVを生成。</li>
      </ul>
    </details>

    <div class="footer">No server / static. Deploy anywhere.</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const sampleInput = document.getElementById('sampleCsv');
    const sourceInput = document.getElementById('sourceCsv');
    const fullNameColSelect = document.getElementById('fullNameCol');
    const convertBtn = document.getElementById('convertBtn');
    const sampleColsDiv = document.getElementById('sampleCols');
    const previewTable = document.getElementById('previewTable');
    const stripAscii = document.getElementById('stripAscii');
    const keepSpaces = document.getElementById('keepSpaces');
    const useZenkaku = document.getElementById('useZenkaku');
    const useHeuristic = document.getElementById('useHeuristic');
    const sampleStatus = document.getElementById('sampleStatus');

    const DEFAULT_TARGET_HEADERS = [
      'company_name','company_number','last_name','first_name','department','position','contact_url','notes','supporter_id'
    ];

    // 入力（日本語）→出力（英語）マッピング（表記ゆれ広め）
    const headerMap = {
      '会社名':'company_name','社名':'company_name','企業名':'company_name','法人名':'company_name','勤務先':'company_name','勤務先名':'company_name','会社/勤務先':'company_name',
      '会社番号':'company_number',
      '部署':'department','部門':'department','所属':'department','所属部署':'department','配属':'department','組織':'department',
      '役職':'position','役割':'position','肩書':'position','ポジション':'position','職位':'position',
      'URL':'contact_url','リンク':'contact_url','Web':'contact_url','サイト':'contact_url',
      '備考':'notes','メモ':'notes','コメント':'notes',
      'サポーターID':'supporter_id','supporterId':'supporter_id'
    };

    // よくある姓（抜粋）
    const SURNAMES = new Set(['佐藤','鈴木','高橋','田中','伊藤','渡辺','山本','中村','小林','加藤','吉田','山田','佐々木','山口','斎藤','斉藤','井上','木村','林','清水','山崎','阿部','森','池田','橋本','石川','山下','中島','小川','前田','岡田','長谷川','村上','藤田','後藤','小野','松本','近藤','石井','坂本','遠藤','青木','藤井','西村','福田','太田','三浦','中野','中川','松田','竹内','小島','田村','金子','和田','石田','中山','原田','酒井','工藤','池上','大西','本田','宮本','平井','柴田','黒田','北村','島田','岩田','菅原','西田','内田','秋山','安田','星野']);

    // 会社語：会社名の検出に使う
    const COMPANY_PAT = /(株式会社|有限会社|合同会社|Inc\.?|LLC|Co\.?,?\s*Ltd\.?|Corporation|Corp\.?|Limited|大学|病院|クリニック|医院|薬局|商事|工業|製作所|ホールディングス|HD|店|センター|研究所)/i;

    let sampleHeaders = [];
    let sourceRows = [];
    let headerless = false;     // ヘッダー無しCSV判定
    let classifyMap = {};       // 見出し→カテゴリのキャッシュ（ヘッダーあり時）

    function setButtonState(){ convertBtn.disabled = !(sampleHeaders.length && sourceRows.length); }

    function tryAutoFullNameCol(headers){
      const keys = ['氏名','姓名','名前','お名前','Name','name','フルネーム'];
      const hit = headers.find(h => keys.some(k => h.includes(k)));
      return hit || '';
    }

    function renderPreview(){
      previewTable.innerHTML = '';
      if(!sourceRows.length) return;
      const headers = Object.keys(sourceRows[0] || {});
      const thead = document.createElement('thead');
      const tr = document.createElement('tr');
      headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; tr.appendChild(th); });
      thead.appendChild(tr); previewTable.appendChild(thead);
      const tbody = document.createElement('tbody');
      sourceRows.slice(0,10).forEach(row=>{
        const tr = document.createElement('tr');
        headers.forEach(h => { const td = document.createElement('td'); td.textContent = row[h] ?? ''; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
      previewTable.appendChild(tbody);
    }

    // ===== ファイル名サフィックス =====
    function deriveSuffixFromSourceName(filename) {
      if (!filename) return '';
      const base = filename.replace(/\.[^.]+$/, '');
      const withoutJinmyaku = base.replace(/人脈/g, '');
      const kanjiChars = (withoutJinmyaku.match(/[\u4E00-\u9FFF]/g) || []).join('');
      if (kanjiChars.length > 0) return sanitizeForFilename(kanjiChars);
      const tokens = base.split(/[^A-Za-z]+/).filter(Boolean).filter(t => !/^(rp|xx)$/i.test(t)).filter(t => !/^\d+$/.test(t));
      if (tokens.length === 0) return '';
      return sanitizeForFilename(tokens.join('_'));
    }
    function sanitizeForFilename(s){ return s.replace(/[\\/:*?"<>|]/g, '').replace(/\s+/g, '').slice(0,80); }

    // ===== ブランク相当判定 =====
    function isBlankish(v){
      if (v == null) return true;
      const s = String(v).replace(/\s+/g,'').replace(/[‐-–—\-―ー−]+/g,'').trim();
      if (!s) return true;
      return /^(N\/A|NA|null|なし|未設定|空|blank|なしです)$/i.test(s);
    }

    // ===== 見出しの正規化と分類 =====
    function normalizeHeaderKey(k){
      if (!k) return '';
      return String(k).trim().replace(/\s+/g,' ').replace(/[()（）【】\[\]<>＜＞]/g,'').toLowerCase();
    }
    function classifyHeader(k){
      const raw = String(k || '');
      const normalized = normalizeHeaderKey(raw);
      // 明示マップ優先
      for (const [jp,en] of Object.entries(headerMap)){
        if (raw.includes(jp)) return en;
      }
      // パターン
      if (/(company|社名|勤務先|勤務先名|法人名|企業名)/i.test(raw)) return 'company_name';
      if (/(部署|部門|所属|配属|組織)/i.test(raw)) return 'department';
      if (/(役職|肩書|職位|役割|position|manager)/i.test(raw)) return 'position';
      if (/(url|link|site|web)/i.test(raw)) return 'contact_url';
      if (/(備考|メモ|コメント|note)/i.test(raw)) return 'notes';
      return null;
    }

    // ===== 名前分割 =====
    function heuristicSplitKanji(s){
      for(const ln of Array.from(SURNAMES).sort((a,b)=>b.length-a.length)){
        if(s.startsWith(ln)) return { last: ln, first: s.slice(ln.length) };
      }
      const kanji = (s.match(/[\u4E00-\u9FFF]/g) || []).length;
      if(kanji >= 4) return { last: s.slice(0,2), first: s.slice(2) };
      if(kanji === 3) return { last: s.slice(0,1), first: s.slice(1) };
      const mid = Math.max(1, Math.floor(s.length/2));
      return { last: s.slice(0,mid), first: s.slice(mid) };
    }

    function normalizeName(raw){
      if (raw == null) return { last: '', first: '' };
      let s = String(raw).trim();
      if (s === '未入力') return { last: '未入力', first: '未入力' };

      const hasKanji = /[\u4E00-\u9FFF]/.test(s);
      const hasLatin = /[A-Za-z]/.test(s);

      if (hasKanji) {
        if (stripAscii.checked) s = s.replace(/[A-Za-z\-_'`~!@#\$%\^&*()=+\[\]{}|;:\",.<>?]+/g, '').trim();
        let i = s.indexOf(' ');
        if (i < 0 && useZenkaku && useZenkaku.checked) i = s.indexOf('　');
        if (i >= 0) {
          const last  = s.slice(0, i).trim();
          let first   = s.slice(i + 1);
          if (!keepSpaces.checked) first = first.replace(/\s+/g, ' ').trim();
          return { last, first };
        }
        if (useHeuristic && useHeuristic.checked) return heuristicSplitKanji(s);
        return { last: s, first: '' };
      }

      if (hasLatin) {
        s = s.replace(/\s+/g, ' ').trim();
        const j = s.lastIndexOf(' ');
        if (j === -1) return { last: s, first: '' };
        const first = s.slice(0, j).trim();
        const last  = s.slice(j + 1).trim();
        return { last, first };
      }

      let k = s.indexOf(' ');
      if (k < 0 && useZenkaku && useZenkaku.checked) k = s.indexOf('　');
      if (k >= 0) {
        const last = s.slice(0, k).trim();
        let first  = s.slice(k + 1);
        if (!keepSpaces.checked) first = first.replace(/\s+/g, ' ').trim();
        return { last, first };
      }
      return { last: s, first: '' };
    }

    // ===== 会社名抽出・列推定 =====
    function extractCompanyLike(value){
      if (!value) return '';
      const s = String(value).trim().replace(/\s+/g,' ');
      const m = s.match(COMPANY_PAT);
      if (m) {
        const end = m.index + m[0].length;
        return s.slice(0, end).trim();
      }
      return s; // 会社語が無い場合はそのまま返す（空判定は別関数）
    }

    function detectCompanyColumn(rows, fullNameKey, maxScan = 6){
      if (!rows.length) return null;
      const keys = Object.keys(rows[0] || {});
      const scanKeys = keys.filter(k => k !== fullNameKey).slice(0, maxScan);

      let bestKey = null, bestScore = 0;
      for (const k of scanKeys){
        let score = 0, nonEmpty = 0;
        for (let i=0; i<Math.min(rows.length, 500); i++){
          const v = rows[i][k];
          if (v == null) continue;
          const s = String(v).trim();
          if (!s) continue;
          nonEmpty++;
          if (COMPANY_PAT.test(s)) score++;
        }
        if (score > bestScore && nonEmpty > 0){
          bestScore = score;
          bestKey = k;
        }
      }
      return bestKey;
    }

    // ===== サンプル列採用 =====
    function adoptHeadersFromSample(meta){
      if(meta && meta.fields && meta.fields.length){
        sampleHeaders = meta.fields;
        sampleColsDiv.textContent = sampleHeaders.join(' | ');
        sampleStatus.textContent = 'サンプルCSVを使用中';
      }else{
        sampleHeaders = DEFAULT_TARGET_HEADERS.slice();
        sampleColsDiv.textContent = sampleHeaders.join(' | ');
        sampleStatus.textContent = 'サンプルCSVが見つからないため既定列を使用中';
      }
    }

    // ===== 解析（ヘッダーあり/なし自動判定） =====
    async function parseSmart(file){
      // 1st: ヘッダーありで読む
      const res1 = await new Promise(resolve=>{
        Papa.parse(file,{ header:true, skipEmptyLines:'greedy',
          complete:(res)=>resolve(res), error:()=>resolve({data:[],meta:{}}) });
      });
      const headers1 = (res1.meta && res1.meta.fields) || [];
      const row0 = (res1.data && res1.data[0]) || null;

      const looksHeaderless = !headers1.length
        || (row0 && Object.keys(row0).length && Object.values(row0).every(v => v == null || v === ''))
        || headers1.some(h => /^column\d+$/i.test(h));

      if (!looksHeaderless) {
        headerless = false;
        return res1;
      }

      // 2nd: ヘッダーなしで読む
      const res2 = await new Promise(resolve=>{
        Papa.parse(file,{ header:false, skipEmptyLines:'greedy',
          complete:(res)=>resolve(res), error:()=>resolve({data:[],meta:{}}) });
      });
      // res2.data は配列の配列。→ __col0, __col1… に変換
      const norm = (res2.data || []).map(arr=>{
        const o = {};
        (arr || []).forEach((v,i)=>{ o[`__col${i}`] = v; });
        return o;
      });
      headerless = true;
      return { data: norm, meta: { fields: Object.keys(norm[0] || {}) } };
    }

    async function parseFile(file,onDone){
      const res = await parseSmart(file);
      onDone(res.data || [], res.meta || {});
    }

    async function fetchLocalSampleFallback(){
      try{
        const resp = await fetch('./admin-customer-list-sample.csv',{ credentials:'same-origin' });
        if(!resp.ok) throw new Error('fetch failed');
        const text = await resp.text();
        const parsed = Papa.parse(text,{ header:true });
        adoptHeadersFromSample(parsed.meta);
      }catch(_){
        adoptHeadersFromSample({});
      }finally{
        setButtonState();
      }
    }

    // ===== イベント：サンプルCSV =====
    sampleInput.addEventListener('change', async()=>{
      const f = sampleInput.files && sampleInput.files[0];
      if(!f) return;
      Papa.parse(f,{ header:true, preview:1,
        complete:(res)=>{ adoptHeadersFromSample(res.meta||{}); setButtonState(); }
      });
    });

    // ===== イベント：元CSV（ヘッダー無しにも対応） =====
    sourceInput.addEventListener('change', async () => {
      const f = sourceInput.files && sourceInput.files[0];
      if (!f) return;

      await parseFile(f, (rows, meta) => {
        sourceRows = rows;
        renderPreview();

        const headers = Object.keys(rows[0] || {});
        // ヘッダーありの場合は見出し→カテゴリの簡易キャッシュ
        classifyMap = {};
        if (!headerless){
          headers.forEach(h => {
            const cls = classifyHeader(h);
            if (cls) classifyMap[h] = cls;
          });
        }

        // フルネーム列プルダウン
        fullNameColSelect.innerHTML =
          '<option value="">自動検出（氏名/姓名/名前/Name）</option>' +
          headers.map((h) => `<option>${h}</option>`).join('');

        let detected = tryAutoFullNameCol(headers);
        if (!detected && headers.length > 0) detected = headers[0]; // ヘッダー無し：最左列を氏名列とみなす
        fullNameColSelect.value = detected || '';
        setButtonState();
      });
    });

    // ===== 変換（2,500件スプリットに対応） =====
    convertBtn.addEventListener('click', ()=>{
      if(!sampleHeaders.length || !sourceRows.length) return;
      const fullNameKey = fullNameColSelect.value || tryAutoFullNameCol(Object.keys(sourceRows[0] || {}));

      const wantLast  = sampleHeaders.includes('last_name')  || sampleHeaders.includes('姓');
      const wantFirst = sampleHeaders.includes('first_name') || sampleHeaders.includes('名');
      const lastKey   = sampleHeaders.includes('last_name')  ? 'last_name'  : (sampleHeaders.includes('姓') ? '姓' : null);
      const firstKey  = sampleHeaders.includes('first_name') ? 'first_name' : (sampleHeaders.includes('名') ? '名' : null);

      // 会社名列の推定（ヘッダー無し or 不確実時用）
      const guessedCompanyKey = detectCompanyColumn(sourceRows, fullNameKey, 6);

      const out = [];
      for(const row of sourceRows){
        const outRow = Object.fromEntries(sampleHeaders.map(h=>[h,'']));

        // 1) 同名ヘッダはコピー
        if (!headerless) {
          for(const h of sampleHeaders){ if(h in row) outRow[h] = row[h]; }
          // 1.5) 日本語→英語のヘッダマッピング
          for(const [jp,en] of Object.entries(headerMap)){
            if(en && sampleHeaders.includes(en) && (jp in row)) outRow[en] = row[jp];
          }
          // 1.6) 見出しの分類で拾えるものも反映
          for (const [k,v] of Object.entries(row)){
            const cls = classifyMap[k] || classifyHeader(k);
            if (cls && sampleHeaders.includes(cls) && isBlankish(outRow[cls])) {
              outRow[cls] = v;
            }
          }
        }

        // 2) 氏名 → 姓/名（未入力／名が空→※／両空→スキップ）
        let skipThisRowDueToEmptyName = false;
        if (fullNameKey && (wantLast || wantFirst)) {
          const nm = normalizeName(row[fullNameKey]);
          let lastVal  = (nm.last  ?? '').trim();
          let firstVal = (nm.first ?? '').trim();

          if (!lastVal && !firstVal) {
            skipThisRowDueToEmptyName = true;
          } else {
            if (lastVal && !firstVal) firstVal = '※';
            if (lastKey)  outRow[lastKey]  = lastVal;
            if (firstKey) outRow[firstKey] = firstVal;
          }
        }
        if (skipThisRowDueToEmptyName) continue;

        // 3) 会社名の設定（強化版）
        if (sampleHeaders.includes('company_name') && isBlankish(outRow['company_name'])) {
          let candidate = '';

          if (!headerless) {
            // 見出しで company_name に分類された列 or “会社っぽい”セルから抽出
            for (const [k, v] of Object.entries(row)) {
              if (v == null) continue;
              const s = String(v).trim();
              if (!s) continue;

              const cls = (classifyMap[k] || classifyHeader(k));
              if (cls === 'company_name') {
                const ex = extractCompanyLike(s);
                if (ex && !isBlankish(ex)) { candidate = ex; break; }
              }
              if (COMPANY_PAT.test(s)) {
                const ex = extractCompanyLike(s);
                if (ex && !isBlankish(ex)) { candidate = ex; break; }
              }
            }
          }

          // ヘッダー無し/不確実：列推定（氏名列を除外）
          if (!candidate && guessedCompanyKey) {
            const ex = extractCompanyLike(row[guessedCompanyKey]);
            if (ex && !isBlankish(ex)) candidate = ex;
          }

          // 最後のフォールバック：3列目（ヘッダー無し時は __col2）
          if (!candidate) {
            const rowHeaders = Object.keys(row || {});
            const thirdKey = headerless ? '__col2' : rowHeaders[2];
            if (thirdKey && thirdKey !== fullNameKey) {
              const ex = extractCompanyLike(row[thirdKey]);
              if (ex && !isBlankish(ex)) candidate = ex;
            }
          }

          if (candidate) outRow['company_name'] = candidate;
        }

        // 4) 1つでも値があれば採用
        const hasAny = Object.values(outRow).some(v => (v!=null) && String(v).trim()!=='');
        if(hasAny) out.push(outRow);
      }

      // ===== 出力（2,500件で分割） =====
      const srcName = (sourceInput.files && sourceInput.files[0] && sourceInput.files[0].name) || '';
      const suffix  = deriveSuffixFromSourceName(srcName);
      const base    = 'converted_admin_customer_list' + (suffix ? '_' + suffix : '');

      const CHUNK = 2500;
      if (out.length > CHUNK){
        const total = Math.ceil(out.length / CHUNK);
        for (let i=0; i<total; i++){
          const chunkRows = out.slice(i*CHUNK, (i+1)*CHUNK);
          downloadCsv(sampleHeaders, chunkRows, `${base}_part${String(i+1).padStart(2,'0')}of${String(total).padStart(2,'0')}.csv`);
        }
      } else {
        downloadCsv(sampleHeaders, out, `${base}.csv`);
      }
    });

    function downloadCsv(headers, rows, filename){
      const csv = Papa.unparse(
        { fields: headers, data: rows.map(r => headers.map(h => r[h] ?? '')) },
        { quotes: true, newline: "\n" }
      );
      const BOM = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([BOM, csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // 初期化：ローカルの admin-customer-list-sample.csv を試す
    fetchLocalSampleFallback();
  </script>
</body>
</html>
